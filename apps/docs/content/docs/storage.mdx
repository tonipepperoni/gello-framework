---
title: Storage
description: Store and retrieve files locally or in the cloud
---

import { Callout } from 'fumadocs-ui/components/callout';

Gello provides a unified API for file storage that works the same whether you're storing files locally or in S3, Azure, or Google Cloud.

## Basic Usage

```typescript
import { Storage } from "@gello/storage"
import { Effect } from "effect"

const handler = Effect.gen(function* () {
  const storage = yield* Storage

  // Store a file
  yield* storage.put("hello.txt", "Hello, World!")

  // Read a file
  const content = yield* storage.get("hello.txt")

  // Check if file exists
  const exists = yield* storage.exists("hello.txt")

  // Delete a file
  yield* storage.delete("hello.txt")
})
```

## File Operations

```typescript
const storage = yield* Storage

// Write files
yield* storage.put("document.txt", "Content here")
yield* storage.put("data.json", JSON.stringify({ foo: "bar" }))

// Read files
const text = yield* storage.getString("document.txt")
const bytes = yield* storage.get("image.png")  // Uint8Array

// Copy and move
yield* storage.copy("original.txt", "backup.txt")
yield* storage.move("old-name.txt", "new-name.txt")

// Delete
yield* storage.delete("file.txt")

// File info
const size = yield* storage.size("file.txt")
const modified = yield* storage.lastModified("file.txt")

// List files
const files = yield* storage.files("uploads/")
```

## Storage Drivers

### Local Disk

Store files on your server's filesystem:

```typescript
import { LocalDisk } from "@gello/storage"

const StorageLive = LocalDisk.layer({
  root: "./storage",
})
```

### Amazon S3

Store files in S3 or S3-compatible services (Cloudflare R2, MinIO):

```typescript
import { S3Disk } from "@gello/storage"

const StorageLive = S3Disk.layer({
  bucket: "my-bucket",
  region: "us-east-1",
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
})
```

For S3-compatible services like Cloudflare R2:

```typescript
const StorageLive = S3Disk.layer({
  bucket: "my-bucket",
  endpoint: "https://xxx.r2.cloudflarestorage.com",
  accessKeyId: process.env.R2_ACCESS_KEY_ID,
  secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,
})
```

### Azure Blob Storage

```typescript
import { AzureDisk } from "@gello/storage"

const StorageLive = AzureDisk.layer({
  accountName: "myaccount",
  accountKey: process.env.AZURE_STORAGE_KEY,
  container: "my-container",
})
```

### Google Cloud Storage

```typescript
import { GCSDisk } from "@gello/storage"

const StorageLive = GCSDisk.layer({
  projectId: "my-project",
  bucket: "my-bucket",
  keyFilename: "/path/to/service-account.json",
})
```

## Configuration

Set your storage driver via environment:

```bash
# .env
STORAGE_DRIVER=s3

# Local
STORAGE_PATH=./storage

# S3
AWS_BUCKET=my-bucket
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your-key
AWS_SECRET_ACCESS_KEY=your-secret
```

## File Uploads

Handle file uploads in your routes:

```typescript
const uploadAvatar = Effect.gen(function* () {
  const storage = yield* Storage
  const body = yield* getFormData()

  const file = body.get("avatar")
  const filename = `avatars/${userId}/${file.name}`

  yield* storage.put(filename, file)

  return json({ path: filename })
})
```

## Generating URLs

### Public URLs

For public files, get a direct URL:

```typescript
const url = yield* storage.url("images/photo.jpg")
// https://my-bucket.s3.amazonaws.com/images/photo.jpg
```

### Temporary URLs

For private files, generate a signed URL that expires:

```typescript
const url = yield* storage.temporaryUrl("private/document.pdf", "1 hour")
// https://...signed-url...
```

### Upload URLs

Let users upload directly to storage (bypasses your server):

```typescript
const uploadUrl = yield* storage.temporaryUploadUrl(
  "uploads/user-file.pdf",
  "15 minutes"
)
// Return this URL to the frontend for direct upload
```

## Serving Files

Return files in HTTP responses:

```typescript
import { download, stream } from "@gello/storage"

// Download (forces browser to save)
const downloadRoute = Effect.gen(function* () {
  const storage = yield* Storage
  return yield* download(storage, "reports/annual.pdf", {
    filename: "Annual-Report.pdf",
  })
})

// Stream (displays in browser if possible)
const viewRoute = Effect.gen(function* () {
  const storage = yield* Storage
  return yield* stream(storage, "images/photo.jpg")
})
```

## Directories

```typescript
const storage = yield* Storage

// Create directory
yield* storage.makeDirectory("uploads/images")

// List directories
const dirs = yield* storage.directories("uploads/")

// Delete directory (and contents)
yield* storage.deleteDirectory("temp/")
```

## Multiple Disks

Use different storage backends for different purposes:

```typescript
import { StorageManager } from "@gello/storage"

const handler = Effect.gen(function* () {
  const manager = yield* StorageManager

  // Default disk (local)
  const local = manager.disk()
  yield* local.put("file.txt", "content")

  // S3 for backups
  const s3 = manager.disk("s3")
  yield* s3.put("backup.sql", backupData)

  // Fast memory disk for temporary files
  const temp = manager.disk("memory")
  yield* temp.put("processing.tmp", data)
})
```

## Testing

Use in-memory storage for tests:

```typescript
import { MemoryDisk } from "@gello/storage"

const TestStorageLive = MemoryDisk.layer()

// Files exist only in memory during the test
```

<Callout type="info">
For production, consider using S3 or a similar cloud storage service. It's more reliable, scales better, and doesn't depend on your server's disk.
</Callout>
