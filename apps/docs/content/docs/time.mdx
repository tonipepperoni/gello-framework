---
title: Time Utilities
description: Type-safe duration and datetime utilities built on Effect â€” testable time operations for cache TTLs, queue delays, and scheduling
---

import { Callout } from 'fumadocs-ui/components/callout';

## Overview

The `@gello/time` library provides time utilities used throughout Gello. It wraps
Effect's Duration and DateTime modules with convenient factories and expiration helpers.
All time-dependent operations are Effects, making them testable with Effect's TestClock.

## Installation

```typescript
import {
  // Duration factories
  seconds, minutes, hours, days, weeks,
  // Special values
  forever, zero,
  // Duration utilities
  toMillis, toSeconds, isFinite, isForever,
  // DateTime operations (Effect-based)
  now, expiresAt, isExpired, remainingTtl,
  // Common presets
  Durations,
} from "@gello/time"
```

## Duration

Durations represent time spans. Create them with factory functions that wrap Effect's Duration:

### Creating Durations

```typescript
import { seconds, minutes, hours, days, weeks, millis } from "@gello/time"

// Basic factories
const fiveSeconds = seconds(5)
const tenMinutes = minutes(10)
const oneHour = hours(1)
const threeDays = days(3)
const twoWeeks = weeks(2)
const fiveHundredMs = millis(500)

// Combine with Effect's Duration arithmetic
import { Duration } from "effect"
const combined = Duration.sum(minutes(5), seconds(30)) // 5:30
```

### Special Values

```typescript
import { forever, zero, isForever, isFinite } from "@gello/time"

// Forever = infinite duration (no expiration)
const noExpiry = forever
isForever(noExpiry)  // true
isFinite(noExpiry)   // false

// Zero = immediate
const immediate = zero
isForever(immediate) // false
isFinite(immediate)  // true
```

### Converting Durations

```typescript
import { toMillis, toSeconds, toMinutes, toHours, forever } from "@gello/time"

const duration = minutes(5)

toMillis(duration)   // 300000
toSeconds(duration)  // 300
toMinutes(duration)  // 5
toHours(duration)    // 0.0833...

// Returns null for infinite durations
toMillis(forever)    // null
```

### Common Presets

```typescript
import { Durations, toMillis } from "@gello/time"

Durations.hundredMillis   // 100ms
Durations.halfSecond      // 500ms
Durations.oneSecond       // 1s
Durations.fiveSeconds     // 5s
Durations.tenSeconds      // 10s
Durations.thirtySeconds   // 30s
Durations.oneMinute       // 1m
Durations.fiveMinutes     // 5m
Durations.fifteenMinutes  // 15m
Durations.thirtyMinutes   // 30m
Durations.oneHour         // 1h
Durations.sixHours        // 6h
Durations.twelveHours     // 12h
Durations.oneDay          // 24h
Durations.oneWeek         // 7d
Durations.forever         // infinite
Durations.zero            // 0

// Example usage
cache.put("session", data, Durations.thirtyMinutes)
```

## DateTime (Effect-based)

DateTime operations are Effects, making them testable with TestClock. Use these for
cache expiration, scheduling, and any time-sensitive logic.

### Current Time

```typescript
import { now, unsafeNow } from "@gello/time"
import { Effect } from "effect"

// Effect-based (testable)
const program = Effect.gen(function* () {
  const currentTime = yield* now
  console.log(currentTime)  // DateTime.Utc
})

// Synchronous (not testable, use sparingly)
const instant = unsafeNow()  // DateTime.Utc
```

### Expiration Calculation

```typescript
import { expiresAt, isExpired, remainingTtl } from "@gello/time"
import { minutes, forever } from "@gello/time"
import { Effect, Option } from "effect"

const program = Effect.gen(function* () {
  // Calculate when something expires
  const expiration = yield* expiresAt(minutes(30))
  // Option<DateTime.Utc> - None for forever

  if (Option.isSome(expiration)) {
    // Check if expired
    const expired = yield* isExpired(expiration.value)
    // boolean

    // Get remaining time
    const remaining = yield* remainingTtl(expiration.value)
    // Duration (zero if expired)
  }

  // Forever returns None
  const noExpiry = yield* expiresAt(forever)
  Option.isNone(noExpiry)  // true
})
```

## Testing with TestClock

<Callout type="info">
Because time operations are Effects, you can use Effect's TestClock to control time in tests.
</Callout>

```typescript
import { expiresAt, isExpired } from "@gello/time"
import { minutes } from "@gello/time"
import { Effect, TestClock, TestContext, Option } from "effect"

const testExpiration = Effect.gen(function* () {
  // Calculate expiration 5 minutes from now
  const expiration = yield* expiresAt(minutes(5))
  expect(Option.isSome(expiration)).toBe(true)

  // Not expired yet
  const expired1 = yield* isExpired(Option.getOrThrow(expiration))
  expect(expired1).toBe(false)

  // Advance time by 6 minutes
  yield* TestClock.adjust(minutes(6))

  // Now it's expired
  const expired2 = yield* isExpired(Option.getOrThrow(expiration))
  expect(expired2).toBe(true)
}).pipe(
  Effect.provide(TestContext.TestContext)
)

await Effect.runPromise(testExpiration)
```

## Usage in Gello

### Cache TTLs

```typescript
import { Cache } from "@gello/cache"
import { minutes, hours, Durations, forever } from "@gello/time"

Effect.gen(function* () {
  const cache = yield* Cache

  // Use duration factories
  yield* cache.put("session", data, minutes(30))
  yield* cache.put("user", user, hours(1))

  // Use presets
  yield* cache.put("config", config, Durations.oneDay)
  yield* cache.put("static", content, forever)
})
```

### Queue Delays

```typescript
import { Queue } from "@gello/queue"
import { seconds, minutes, scheduleIn } from "@gello/time"
import { Effect } from "effect"

Effect.gen(function* () {
  const queue = yield* Queue

  // Delay job execution
  yield* queue.push("emails", job, { delay: minutes(5) })

  // Schedule for specific time
  const runAt = yield* scheduleIn(hours(2))
  yield* queue.push("reports", job, { runAt })
})
```

### Middleware Timeouts

```typescript
import { seconds } from "@gello/time"
import { Effect } from "effect"

// Timeout middleware
const withTimeout = (duration: Duration) =>
  Effect.timeout(duration)

// Usage
const handler = myHandler.pipe(
  withTimeout(seconds(30))
)
```

## API Reference

### Duration Factories

| Function | Description |
|----------|-------------|
| `millis(n)` | Create duration in milliseconds |
| `seconds(n)` | Create duration in seconds |
| `minutes(n)` | Create duration in minutes |
| `hours(n)` | Create duration in hours |
| `days(n)` | Create duration in days |
| `weeks(n)` | Create duration in weeks |
| `forever` | Infinite duration (no expiration) |
| `zero` | Zero duration (immediate) |

### DateTime Operations

| Function | Description |
|----------|-------------|
| `now` | Current UTC time as Effect |
| `expiresAt(ttl)` | Calculate expiration from duration |
| `isExpired(dt)` | Check if datetime has passed |
| `remainingTtl(dt)` | Get remaining duration until datetime |
| `scheduleIn(d)` | Calculate datetime d from now |
